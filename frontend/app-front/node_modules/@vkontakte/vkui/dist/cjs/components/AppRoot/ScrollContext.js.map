{"version":3,"sources":["../../../../src/components/AppRoot/ScrollContext.tsx"],"sourcesContent":["import * as React from 'react';\nimport { noop } from '@vkontakte/vkjs';\nimport { clamp } from '../../helpers/math';\nimport { useDOM } from '../../lib/dom';\nimport { useIsomorphicLayoutEffect } from '../../lib/useIsomorphicLayoutEffect';\nimport { HasChildren } from '../../types';\n\nconst clearDisableScrollStyle = (node: HTMLElement) => {\n  Object.assign(node.style, {\n    position: '',\n    top: '',\n    left: '',\n    right: '',\n    overflowY: '',\n    overflowX: '',\n  });\n};\n\nconst getPageYOffsetWithoutKeyboardHeight = (window: Window) => {\n  // Note: здесь расчёт на то, что `clientHeight` равен `window.innerHeight`.\n  //  Это достигается тем, что тегу `html` задали`height: 100%` и у него нет отступов сверху и снизу. Если есть отступы,\n  //  то надо задать `box-sizing: border-box`, чтобы они не учитывались.\n  const diffOfClientHeightAndViewportHeight =\n    window.document.documentElement.clientHeight - window.innerHeight;\n  return window.pageYOffset - diffOfClientHeightAndViewportHeight;\n};\n\nexport type GetScrollOptions = {\n  compensateKeyboardHeight?: boolean;\n};\n\nexport interface ScrollContextInterface {\n  getScroll: (this: void, options?: GetScrollOptions) => { x: number; y: number };\n  scrollTo: (this: void, x?: number, y?: number) => void;\n  isScrollLock: boolean;\n  enableScrollLock: (this: void) => void;\n  disableScrollLock: (this: void) => void;\n  beforeScrollLockFnSetRef?: React.RefObject<Set<() => void>>;\n}\n\nexport const ScrollContext: React.Context<ScrollContextInterface> =\n  React.createContext<ScrollContextInterface>({\n    getScroll: () => ({ x: 0, y: 0 }),\n    scrollTo: noop,\n    isScrollLock: false,\n    enableScrollLock: noop,\n    disableScrollLock: noop,\n  });\n\nexport const useScroll = (): ScrollContextInterface => React.useContext(ScrollContext);\n\nexport interface ScrollControllerProps extends HasChildren {\n  elRef: React.RefObject<HTMLElement>;\n}\n\nexport const GlobalScrollController = ({ children }: ScrollControllerProps): React.ReactNode => {\n  const { window, document } = useDOM();\n  const [isScrollLock, setScrollLock] = React.useState(false);\n  const beforeScrollLockFnSetRef = React.useRef<Set<() => void>>(new Set());\n\n  const getScroll = React.useCallback<ScrollContextInterface['getScroll']>(\n    (options = { compensateKeyboardHeight: true }) => ({\n      x: window!.pageXOffset,\n      y: options.compensateKeyboardHeight\n        ? getPageYOffsetWithoutKeyboardHeight(window!)\n        : window!.pageYOffset,\n    }),\n    [window],\n  );\n  const scrollTo = React.useCallback<ScrollContextInterface['scrollTo']>(\n    (x = 0, y = 0) => {\n      // Some iOS versions do not normalize scroll — do it manually.\n      window!.scrollTo(\n        x ? clamp(x, 0, document!.body.scrollWidth - window!.innerWidth) : 0,\n        y ? clamp(y, 0, document!.body.scrollHeight - window!.innerHeight) : 0,\n      );\n    },\n    [document, window],\n  );\n\n  const enableScrollLock = React.useCallback<ScrollContextInterface['enableScrollLock']>(() => {\n    beforeScrollLockFnSetRef.current.forEach((fn) => {\n      fn();\n    });\n\n    const scrollY = window!.pageYOffset;\n    const scrollX = window!.pageXOffset;\n    const overflowY = window!.innerWidth > document!.documentElement.clientWidth ? 'scroll' : '';\n    const overflowX = window!.innerHeight > document!.documentElement.clientHeight ? 'scroll' : '';\n\n    Object.assign(document!.body.style, {\n      position: 'fixed',\n      top: `-${scrollY}px`,\n      left: `-${scrollX}px`,\n      right: '0',\n      overflowY,\n      overflowX,\n    });\n    setScrollLock(true);\n  }, [document, window]);\n\n  const disableScrollLock = React.useCallback<ScrollContextInterface['disableScrollLock']>(() => {\n    const scrollY = document!.body.style.top;\n    const scrollX = document!.body.style.left;\n\n    clearDisableScrollStyle(document!.body);\n    window!.scrollTo(-parseInt(scrollX || '0'), -parseInt(scrollY || '0'));\n    setScrollLock(false);\n  }, [document, window]);\n\n  const scrollController = React.useMemo<ScrollContextInterface>(\n    () => ({\n      getScroll,\n      scrollTo,\n      isScrollLock,\n      disableScrollLock,\n      enableScrollLock,\n\n      beforeScrollLockFnSetRef: beforeScrollLockFnSetRef,\n    }),\n    [getScroll, scrollTo, isScrollLock, disableScrollLock, enableScrollLock],\n  );\n\n  return <ScrollContext.Provider value={scrollController}>{children}</ScrollContext.Provider>;\n};\n\nexport const ElementScrollController = ({\n  elRef,\n  children,\n}: ScrollControllerProps): React.ReactNode => {\n  const [isScrollLock, setScrollLock] = React.useState(false);\n  const beforeScrollLockFnSetRef = React.useRef<Set<() => void>>(new Set());\n\n  const getScroll = React.useCallback<ScrollContextInterface['getScroll']>(\n    () => ({\n      x: elRef.current?.scrollLeft ?? 0,\n      y: elRef.current?.scrollTop ?? 0,\n    }),\n    [elRef],\n  );\n  const scrollTo = React.useCallback<ScrollContextInterface['scrollTo']>(\n    (x = 0, y = 0) => {\n      const el = elRef.current;\n      // Some iOS versions do not normalize scroll — do it manually.\n      el?.scrollTo(\n        x ? clamp(x, 0, el.scrollWidth - el.clientWidth) : 0,\n        y ? clamp(y, 0, el.scrollHeight - el.clientHeight) : 0,\n      );\n    },\n    [elRef],\n  );\n\n  const enableScrollLock = React.useCallback<ScrollContextInterface['enableScrollLock']>(() => {\n    const el = elRef.current;\n    if (!el) {\n      return;\n    }\n    beforeScrollLockFnSetRef.current.forEach((fn) => {\n      fn();\n    });\n\n    const scrollY = el.scrollTop;\n    const scrollX = el.scrollLeft;\n    const overflowY = el.scrollWidth > el.clientWidth ? 'scroll' : '';\n    const overflowX = el.scrollHeight > el.clientHeight ? 'scroll' : '';\n\n    Object.assign(el.style, {\n      position: 'absolute',\n      top: `-${scrollY}px`,\n      left: `-${scrollX}px`,\n      right: '0',\n      overflowY,\n      overflowX,\n    });\n    setScrollLock(true);\n  }, [elRef]);\n\n  const disableScrollLock = React.useCallback<ScrollContextInterface['disableScrollLock']>(() => {\n    const el = elRef.current;\n    if (!el) {\n      return;\n    }\n\n    const scrollY = el.style.top;\n    const scrollX = el.style.left;\n\n    clearDisableScrollStyle(el);\n    el.scrollTo(-parseInt(scrollX || '0'), -parseInt(scrollY || '0'));\n    setScrollLock(false);\n  }, [elRef]);\n\n  const scrollController = React.useMemo<ScrollContextInterface>(\n    () => ({\n      getScroll,\n      scrollTo,\n      isScrollLock,\n      disableScrollLock,\n      enableScrollLock,\n      beforeScrollLockFnSetRef,\n    }),\n    [getScroll, scrollTo, isScrollLock, disableScrollLock, enableScrollLock],\n  );\n\n  return <ScrollContext.Provider value={scrollController}>{children}</ScrollContext.Provider>;\n};\n\n/**\n * Вызывает функцию effect, до блокировки прокрутки\n * @param effect функция, которая может возвращать функцию очистки\n * @param deps effect обновится только при изменении значений в списке.\n */\nexport const useScrollLockEffect = (\n  effect: React.EffectCallback,\n  deps: React.DependencyList,\n): void => {\n  const destructorRef = React.useRef<ReturnType<React.EffectCallback>>(noop);\n  const { isScrollLock, beforeScrollLockFnSetRef } = useScroll();\n\n  // Изменяем effectCallback только при изменении deps\n  const effectCallback = React.useCallback(() => {\n    destructorRef.current = effect();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, deps);\n\n  // Добавляем effectCallback в список функций, которые необходимо вызвать\n  // до блокировки\n  React.useEffect(() => {\n    const beforeSet = beforeScrollLockFnSetRef?.current;\n    if (!beforeSet) {\n      return noop;\n    }\n\n    beforeSet.add(effectCallback);\n\n    return () => {\n      beforeSet.delete(effectCallback);\n    };\n  }, [beforeScrollLockFnSetRef, effectCallback]);\n\n  // Вызываем сбрасывающую функцию, после отключения блокировки\n  React.useEffect(() => {\n    if (!isScrollLock && destructorRef.current) {\n      destructorRef.current();\n    }\n  }, [isScrollLock]);\n};\n\nexport const useScrollLock = (enabled = true): void => {\n  const { enableScrollLock, disableScrollLock, isScrollLock } = useScroll();\n  useIsomorphicLayoutEffect(() => {\n    if (enabled && !isScrollLock) {\n      enableScrollLock();\n      return disableScrollLock;\n    }\n    return noop;\n  }, [enableScrollLock, disableScrollLock, enabled]);\n};\n"],"names":["ElementScrollController","GlobalScrollController","ScrollContext","useScroll","useScrollLock","useScrollLockEffect","clearDisableScrollStyle","node","Object","assign","style","position","top","left","right","overflowY","overflowX","getPageYOffsetWithoutKeyboardHeight","window","diffOfClientHeightAndViewportHeight","document","documentElement","clientHeight","innerHeight","pageYOffset","React","createContext","getScroll","x","y","scrollTo","noop","isScrollLock","enableScrollLock","disableScrollLock","useContext","children","useDOM","setScrollLock","useState","beforeScrollLockFnSetRef","useRef","Set","useCallback","options","compensateKeyboardHeight","pageXOffset","clamp","body","scrollWidth","innerWidth","scrollHeight","current","forEach","fn","scrollY","scrollX","clientWidth","parseInt","scrollController","useMemo","Provider","value","elRef","scrollLeft","scrollTop","el","effect","deps","destructorRef","effectCallback","useEffect","beforeSet","add","delete","enabled","useIsomorphicLayoutEffect"],"mappings":"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"}